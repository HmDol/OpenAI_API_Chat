<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="shortcut icon" href="sample.jpg" type="image/x-icon">
    <link rel="icon" href="sample.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운세보는 챗도지</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
     

        .chat-container {
            width: 350px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            
        }

        .message {
            font-size : 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background-color: #007BFF;
            color: #fff;
        }

        .user-message {
            align-self: flex-end;
            background-color: #28A745;
        }

        input[type="text"] {
            width: 72%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
        }

        button {
            background-color: #007BFF;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .user-message{
            margin-left : 100px;
        }

        .intro-container{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items : center;
        }
        #doge{
            width: 30%;
            height: 30% ;
        }
    </style>
</head>

<body>
    
    <div id="intro" class="intro-container">
        <h1>운세를 알려드립니다.</h1>
        <img id="doge" src="doge.jpg" alt="이미지 없어 시발">
        <label for="date">생년원일 선택 <input id ="date" type="date"></label> 
        <label for="time">태어난 시간 <input id="time" type="time"></label> 
        <button onclick="start()">보내기</button>
    </div>


    <div id="chat-container" class="chat-container" style="display:none">
        <h1>챗도지 시스템</h1>
        <div class="chat-messages" id="chat-messages" >
            <div class="message bot-message">
                챗도지 시스템에 오신 것을 환영합니다! 운세를 보려면 'send' 버튼을 클릭하세요.
            </div>
        </div>
        <input onkeyup="if(window.event.keyCode==13){sendMessage()}"type="text" id="user-input" placeholder="메시지를 입력하세요...">
        <button onclick="sendMessage()">Send</button>
    </div>

   <!-- Add this script section before your previous script section -->
<script>
    // Function to add a message to the chat UI

    let userMs_list =[];
    let assistantMs_list = [];
    let myDateTime = '';

    function start(){
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        if(date ==''){
            alert("생년월일을 선택해주세요");
            return;
        } 
        if(time == ''){
            alert("태어난 시간을 선택해주세요");
            return;
        }
        myDateTime = date + " " + time;
        // console.log(myDateTime);
        document.getElementById("intro").style.display="none";
        document.getElementById("chat-container").style.display="block";
    }
    function addMessage(message, isUser) {
        const chatMessages = document.getElementById("chat-messages");
        const messageContainer = document.createElement("div");
        // console.log(messageContainer + '1');
        messageContainer.classList.add("message");
        messageContainer.classList.add(isUser ? "user-message" : "bot-message");
        // console.log(messageContainer.classList +'2');
        messageContainer.textContent = message;
        // console.log(messageContainer.textContent);
        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the latest message
    }

    // Function to send a message to the server
    async function sendMessageToServer(message) {
        try {
            const response = await fetch('http://localhost:3000/fortuneTell', { // Replace with your server's URL
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ 
                    // message,
                    userMs_list : userMs_list,
                    assistantMs_list : assistantMs_list,
                    myDateTime : myDateTime,
                 }),
            });

            const data = await response.json();
            console.log(data);
            return data.assistant;
        } catch (error) {
            console.error(error);
            return "운세를 가져오는 중 오류가 발생했습니다.";
        }
    }

    async function sendMessage() {
        const userMessage = document.getElementById("user-input").value;
        document.getElementById("user-input").value = "";
        if (userMessage) {
            addMessage(userMessage, true);
            userMs_list.push(userMessage); // 유저 메세지 추가

            try {
                const assistantMessage = await sendMessageToServer(userMessage);
                addMessage(assistantMessage, false);
                assistantMs_list.push(assistantMessage);  // 어시스트 메서지 추가
            } catch (error) {
                console.error(error);
            }

            document.getElementById("user-input").value = "";
        }
    }
</script>



</html>